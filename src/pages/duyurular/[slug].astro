---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ActivityCard from '../../components/ActivityCard.astro';
import { getCollection } from 'astro:content';
import { formatDate } from '../../lib/format';

export async function getStaticPaths() {
  const activities = await getCollection('activities', ({ data }) => !data.draft);
  return activities.map((activity) => ({
    params: { slug: activity.slug },
    props: { activity }
  }));
}

const { activity } = Astro.props;
const { Content } = await activity.render();

const related = (await getCollection('activities', ({ data }) => !data.draft))
  .filter((item) => item.slug !== activity.slug)
  .slice(0, 3);

const structuredData = [
  {
    '@context': 'https://schema.org',
    '@type': 'NewsArticle',
    headline: activity.data.title,
    description: activity.data.summary,
    image: activity.data.featured_image,
    datePublished: activity.data.date,
    url: `https://www.balmerkezbirligi.org/duyurular/${activity.slug}/`,
    author: {
      '@type': 'Organization',
      name: 'Türkiye Bal Üreticileri Merkez Birliği'
    }
  }
];
---

<BaseLayout
  title={activity.data.title}
  description={activity.data.summary}
  canonical={`https://www.balmerkezbirligi.org/duyurular/${activity.slug}/`}
  image={activity.data.featured_image}
  type="article"
  structuredData={structuredData}
>
  <section class="page-shell section-gap space-y-6">
    <div class="space-y-2">
      <p class="text-xs font-semibold uppercase tracking-[0.18em] text-brand-700">
        Duyuru {activity.data.date ? `• ${formatDate(activity.data.date)}` : ''}
      </p>
      <h1 class="text-3xl leading-tight text-slate-900">{activity.data.title}</h1>
      <p class="text-base text-slate-700">{activity.data.summary}</p>
    </div>

    {activity.data.featured_image && (
      <picture class="block overflow-hidden rounded-3xl border border-sand-200 shadow-soft">
        <source srcset={activity.data.featured_image.replace('-1600', '-900')} media="(max-width: 768px)" />
        <img
          src={activity.data.featured_image}
          alt={activity.data.title}
          loading="lazy"
          decoding="async"
          class="w-full"
        />
      </picture>
    )}

    <article class="markdown">
      <Content />
    </article>
  </section>

  {related.length > 0 && (
    <section class="section-gap bg-white">
      <div class="page-shell space-y-4">
        <h2 class="text-xl font-semibold text-slate-900">İlgili duyurular</h2>
        <div class="grid gap-6 md:grid-cols-3">
          {related.map((item) => (
            <ActivityCard
            title={item.data.title}
            summary={item.data.summary}
            date={item.data.date}
            image={item.data.featured_image}
            href={`/duyurular/${item.slug}/`}
          />
          ))}
        </div>
      </div>
    </section>
  )}
</BaseLayout>
