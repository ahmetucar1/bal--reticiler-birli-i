---
import BaseLayout from '../../layouts/BaseLayout.astro';
import SectionHeading from '../../components/SectionHeading.astro';
import ActivityCard from '../../components/ActivityCard.astro';
import { getCollection } from 'astro:content';

const activities = (await getCollection('activities', ({ data }) => !data.draft)).sort((a, b) => {
  const aDate = a.data.date ? new Date(a.data.date).getTime() : 0;
  const bDate = b.data.date ? new Date(b.data.date).getTime() : 0;
  return bDate - aDate;
});
const legacyActivities = activities.filter((item) => item.data.tags?.includes('sunum'));

const duyuruItems = [
  {
    src: '/assets/duyurular/0.jpeg',
    title:
      'Türkiye Bal Üreticiler Merkez Birliğinde gerçekleştirilen genel kurulda Fırat Çenberlitaş güven tazeleyerek görevine devam etti.',
    date: '2026',
    href: '/duyurular/detay?id=sanliurfa-genel-kurul'
  },
  {
    src: '/assets/duyurular/1.1.jpeg',
    title:
      'Bitlis ve Hizan birlik başkanlarımızla birlikte gerçekleştirdiğimiz Bitlis Valimiz Sayın Ahmet Karakaya ziyareti.',
    date: '18 Şubat 2026',
    href: '/duyurular/detay?id=bitlis-valisi-ziyareti'
  },
  {
    src: '/assets/duyurular/2.jpg',
    title:
      'Diyarbakır Bal Üreticileri Birliğimizi ziyaret ederek, önceki dönem başkanlarımızdan merhum Ali Rıza Demir’in oğullarına taziyelerimizi ilettik.',
    date: '2026',
    href: '/duyurular/detay?id=diyarbakir-birligi-taziye-ziyareti'
  },
  {
    src: '/assets/duyurular/3.jpg',
    title:
      'Yönetim kurulu olarak; Şanlıurfa Arıcılar Birliği Başkanımızın kıymetli annesinin vefatı dolayısıyla kendisini ziyaret ederek başsağlığı dileklerimizi ilettik.',
    date: '2026',
    href: '/duyurular/detay?id=sanliurfa-bassagligi-ziyareti'
  },
  {
    src: '/assets/duyurular/4.jpg',
    title:
      'Ankara’da Teşkilatlanma Daire Başkanı Sayın Ahmet Ünsal ile il bazlı yapılanma konusunda son derece olumlu görüşmeler gerçekleştirilmiştir. Bulundukları illerde ilçe bazlı kurulmuş birliklerimizden, mali genel kurullarını yapmadan önce il birliği statüsüne geçmeyi düşünenler varsa, çok ivedi bir şekilde Merkez Birliğimiz ile iletişime geçmeleri gerekmektedir. İl bazlı yapılanma sürecinde birkaç işlemin tamamlanmasının ardından il bazlı statüye geçiş mümkün olacaktır. Birliklerimizin daha güçlü ve kurumsal bir yapıya kavuşabilmesi adına, ilçe bazlı değil il bazlı teşkilatlanma büyük önem arz etmektedir.',
    date: '2026',
    href: '/duyurular/detay?id=ankara-teskilatlanma-gorusmesi'
  },
  {
    src: '/assets/duyurular/5.jpg',
    title:
      'Türk Patent ve Marka Kurumu Başkanı Prof. Dr. Muhammed Zeki Durak’ı, Merkez Birliğimiz olarak makamında ziyaret ettik. Bal ve arı ürünlerimizin markalaşması ile coğrafi işaretler konularında verimli bir görüşme gerçekleştirdik.',
    date: '2026',
    href: '/duyurular/detay?id=turk-patent-ziyareti'
  },
  {
    src: '/assets/duyurular/7.jpeg',
    title:
      'Bal üreticileri birliklerimiz her geçen gün daha kurumsal bir yapıya kavuşuyor ve büyümeye devam ediyor. Gaziantep Bal Üreticileri Birliği Başkanımız Mehmet Uçar’ın öncülüğünde, bakanlık tarafından belgelendirilen eğitim programı kapsamında; Merkez Birliğimiz Yönetim Kurulu Başkan Yardımcımız Mehmet Ali Kutlu hocamızın eğitmen olarak yer aldığı proje doğrultusunda belgelendirme töreni gerçekleştirilmiş ve başarılı arıcılarımıza bakanlık onaylı ana arı sertifikaları takdim edilmiştir. Emeği geçen başta Gaziantep Birliğimiz olmak üzere, kıymetli hocamıza ve tüm paydaşlara teşekkür eder, sertifika alan arıcılarımızı tebrik ederiz',
    date: '2026',
    href: '/duyurular/detay?id=gaziantep-sertifika-toreni'
  },
  {
    src: '/assets/duyurular/8.jpeg',
    title:
      'Türkiye Arı Yetiştiricileri Merkez Birliği Genel Başkanı Ali Demir ve kıymetli yönetim kurulu bugün Merkez Birliğimize hayırlı olsun ziyaretinde bulunmuştur.',
    date: '2026',
    href: '/duyurular/detay?id=ari-yetistiricileri-birligi-hayirli-olsun'
  }
];

---

<BaseLayout
  title="Duyurular"
  description="Genel kurul ziyaretleri, saha çalışmaları ve resmi duyurular."
  canonical="https://www.balmerkezbirligi.org/duyurular"
>
  <section class="page-shell section-gap space-y-8">
    <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
      <SectionHeading
        eyebrow="2026 yılı"
        title="Genel kurul duyuruları"
        description="Haftalık ziyaretler, saha çalışmaları ve resmî bildirimler."
      />
      <p class="text-sm text-slate-700" data-duyuru-count>{duyuruItems.length} duyuru</p>
    </div>

    <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3" data-duyuru-grid>
      {duyuruItems.map((item) => (
        <article class="group flex h-full flex-col overflow-hidden rounded-2xl border border-sand-200 bg-white shadow-card transition hover:-translate-y-1 hover:shadow-soft">
          <a class="block h-full" href={item.href}>
            <div class="relative aspect-[4/3] overflow-hidden bg-sand-100">
              <img src={item.src} alt={item.title} loading="lazy" decoding="async" class="h-full w-full object-cover transition duration-300 group-hover:scale-105" />
            </div>
            <div class="flex flex-col gap-2 px-4 py-3 text-slate-900">
              <p class="text-[11px] uppercase tracking-[0.18em] text-slate-500">{item.date}</p>
              <h3 class="text-sm font-semibold line-clamp-1">{item.title}</h3>
              <p class="text-xs text-pine-700">Devamını oku →</p>
            </div>
          </a>
        </article>
      ))}
    </div>

    <div class="pt-6 border-t border-sand-200"></div>

    <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
      <SectionHeading
        eyebrow="Önceki çalışmalar"
        title="Sunumdan yayınlanan faaliyetler"
        description="Geçmiş dönem saha notları ve proje kayıtları."
      />
      <p id="result-count" class="text-sm text-slate-700">{legacyActivities.length} kayıt</p>
    </div>

    <div class="flex flex-col gap-3 rounded-3xl border border-sand-200 bg-white p-4 shadow-card">
      <label class="sr-only" for="arama">Duyurularda ara</label>
      <input
        id="arama"
        type="search"
        name="q"
        placeholder="Kelime veya yer adı ile ara..."
        class="w-full rounded-xl border border-sand-200 bg-sand-50 px-4 py-3 text-sm outline-none transition focus:border-brand-300 focus:bg-white focus:shadow-soft"
      />
    </div>

    <div id="activity-grid" class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
      {legacyActivities.map((item) => (
        <div class="activity-card" data-title={item.data.title.toLowerCase()}>
          <ActivityCard
            title={item.data.title}
            summary={item.data.summary}
            date={item.data.date}
            image={item.data.featured_image}
            href={`/duyurular/${item.slug}/`}
          />
        </div>
      ))}
    </div>

    <div
      id="empty-state"
      class="hidden rounded-2xl border border-dashed border-sand-200 bg-sand-50 p-6 text-center text-sm text-slate-700"
    >
      Aradığınız kriterde kayıt bulunamadı. Farklı bir anahtar kelime veya etiket deneyin.
    </div>
  </section>

  <script is:inline>
    (() => {
      const firebaseConfig = {
        apiKey: "AIzaSyAl_TPmEOlbliY3CDig7p-VGbSEVoFxl2c",
        authDomain: "merkez-birligi.firebaseapp.com",
        projectId: "merkez-birligi",
        storageBucket: "merkez-birligi.firebasestorage.app",
        messagingSenderId: "1017642940775",
        appId: "1:1017642940775:web:7c7ace1b2cba16a6fdd7c2",
        measurementId: "G-LT1MWENXB7"
      };

      const loadScript = (src) =>
        new Promise((resolve, reject) => {
          const existing = document.querySelector(`script[src="${src}"]`);
          if (existing) {
            if (existing.dataset.loaded === "true") return resolve();
            existing.addEventListener("load", () => resolve(), { once: true });
            existing.addEventListener("error", () => reject(new Error(`Firebase yüklenemedi: ${src}`)), { once: true });
            return;
          }
          const script = document.createElement("script");
          script.src = src;
          script.async = true;
          script.addEventListener("load", () => {
            script.dataset.loaded = "true";
            resolve();
          });
          script.addEventListener("error", () => reject(new Error(`Firebase yüklenemedi: ${src}`)));
          document.head.appendChild(script);
        });

      const ensureFirebase = async () => {
        if (window.firebase) return;
        await loadScript("https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js");
        await loadScript("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js");
        if (!window.firebase) {
          throw new Error("Firebase yüklenemedi.");
        }
      };

    const formatDate = (value) => {
      if (!value) return "2026";
      if (typeof value === "string") {
        const parsed = new Date(value);
        if (Number.isNaN(parsed.getTime())) return value;
        return new Intl.DateTimeFormat("tr-TR", { day: "2-digit", month: "long", year: "numeric" }).format(parsed);
      }
      const date = value instanceof Date ? value : value.toDate?.() || new Date(value);
      if (Number.isNaN(date.getTime())) return "2026";
      return new Intl.DateTimeFormat("tr-TR", { day: "2-digit", month: "long", year: "numeric" }).format(date);
    };

    const renderCards = (items) => {
      const grid = document.querySelector("[data-duyuru-grid]");
      if (!grid || !items.length) return;
      grid.innerHTML = items
        .map((item) => {
          const href = `/duyurular/detay?id=${item.id}`;
          return `
            <article class=\"group flex h-full flex-col overflow-hidden rounded-2xl border border-sand-200 bg-white shadow-card transition hover:-translate-y-1 hover:shadow-soft\">
              <a class=\"block h-full\" href=\"${href}\">
                <div class=\"relative aspect-[4/3] overflow-hidden bg-sand-100\">
                  <img src=\"${item.coverUrl}\" alt=\"${item.title}\" loading=\"lazy\" decoding=\"async\" class=\"h-full w-full object-cover transition duration-300 group-hover:scale-105\" />
                </div>
                <div class=\"flex flex-col gap-2 px-4 py-3 text-slate-900\">
                  <p class=\"text-[11px] uppercase tracking-[0.18em] text-slate-500\">${item.dateLabel}</p>
                  <h3 class=\"text-sm font-semibold line-clamp-1\">${item.title}</h3>
                  <p class=\"text-xs text-pine-700\">Devamını oku →</p>
                </div>
              </a>
            </article>
          `;
        })
        .join("");
    };

    const searchInput = document.querySelector('#arama');
    const cards = Array.from(document.querySelectorAll('.activity-card'));
    const empty = document.querySelector('#empty-state');
    const countEl = document.querySelector('#result-count');
    const duyuruCountEl = document.querySelector('[data-duyuru-count]');

    const applyFilter = () => {
      const query = (searchInput.value || '').toLowerCase();
      let visible = 0;

      cards.forEach((card) => {
        const title = card.dataset.title || '';
        const matchesQuery = !query || title.includes(query);
        const show = matchesQuery;
        card.classList.toggle('hidden', !show);
        if (show) visible += 1;
      });

      if (empty) empty.classList.toggle('hidden', visible > 0);
      if (countEl) countEl.textContent = `${visible} kayıt`;
    };

    searchInput?.addEventListener('input', () => {
      applyFilter();
    });

    const loadDuyurular = async () => {
      try {
        await ensureFirebase();
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const snapshot = await db.collection("announcements").get();
        const items = snapshot.docs
          .map((docSnap) => {
            const data = docSnap.data() || {};
            const coverUrl = data.coverUrl || data.images?.[0]?.url;
            if (!data.title || !coverUrl) return null;
            return {
              id: docSnap.id,
              title: data.title,
              coverUrl,
              dateLabel: formatDate(data.eventDate || data.publishedAt || data.createdAt),
              order: typeof data.order === "number" ? data.order : null,
              publishedAt: data.publishedAt || data.createdAt
            };
          })
          .filter(Boolean);

        if (items.length > 0) {
          const sorted = [...items].sort((a, b) => {
            const orderA = a.order ?? 9999;
            const orderB = b.order ?? 9999;
            if (orderA !== orderB) return orderA - orderB;
            const timeA = a.publishedAt?.seconds || 0;
            const timeB = b.publishedAt?.seconds || 0;
            return timeB - timeA;
          });
          renderCards(sorted);
          if (duyuruCountEl) duyuruCountEl.textContent = `${sorted.length} duyuru`;
        }
      } catch (error) {
        // fallback to static content
      }
    };

    applyFilter();
    loadDuyurular();
  })();
  </script>
</BaseLayout>
