---
import BaseLayout from '../../layouts/BaseLayout.astro';
import SectionHeading from '../../components/SectionHeading.astro';
import ActivityCard from '../../components/ActivityCard.astro';
import { getCollection } from 'astro:content';

const activities = (await getCollection('activities', ({ data }) => !data.draft)).sort((a, b) => {
  const aDate = a.data.date ? new Date(a.data.date).getTime() : 0;
  const bDate = b.data.date ? new Date(b.data.date).getTime() : 0;
  return bDate - aDate;
});

---

<BaseLayout
  title="Faaliyetler"
  description="Saha çalışmaları, eğitimler, ziyaretler ve projelerden öne çıkan faaliyetler."
  canonical="https://www.balmerkezbirligi.org/faaliyetler"
>
  <section class="page-shell section-gap space-y-8">
    <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
      <SectionHeading
        eyebrow="Faaliyet arşivi"
        title="Güncel çalışmalar ve ziyaretler"
        description="Saha temasları, eğitimler ve paydaş buluşmalarından notlar."
      />
      <p id="result-count" class="text-sm text-slate-700">{activities.length} kayıt</p>
    </div>

    <div class="flex flex-col gap-3 rounded-3xl border border-sand-200 bg-white p-4 shadow-card">
      <label class="sr-only" for="arama">Faaliyetlerde ara</label>
      <input
        id="arama"
        type="search"
        name="q"
        placeholder="Kelime veya yer adı ile ara..."
        class="w-full rounded-xl border border-sand-200 bg-sand-50 px-4 py-3 text-sm outline-none transition focus:border-brand-300 focus:bg-white focus:shadow-soft"
      />
    </div>

    <div id="activity-grid" class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
      {activities.map((item) => (
        <div class="activity-card" data-title={item.data.title.toLowerCase()}>
          <ActivityCard
            title={item.data.title}
            summary={item.data.summary}
            date={item.data.date}
            image={item.data.featured_image}
            href={`/faaliyetler/${item.slug}/`}
          />
        </div>
      ))}
    </div>

    <div
      id="empty-state"
      class="hidden rounded-2xl border border-dashed border-sand-200 bg-sand-50 p-6 text-center text-sm text-slate-700"
    >
      Aradığınız kriterde kayıt bulunamadı. Farklı bir anahtar kelime veya etiket deneyin.
    </div>
  </section>

  <script type="module">
    const searchInput = document.querySelector('#arama');
    const cards = Array.from(document.querySelectorAll('.activity-card'));
    const empty = document.querySelector('#empty-state');
    const countEl = document.querySelector('#result-count');

    const applyFilter = () => {
      const query = (searchInput.value || '').toLowerCase();
      let visible = 0;

      cards.forEach((card) => {
        const title = card.dataset.title || '';
        const matchesQuery = !query || title.includes(query);
        const show = matchesQuery;
        card.classList.toggle('hidden', !show);
        if (show) visible += 1;
      });

      if (empty) empty.classList.toggle('hidden', visible > 0);
      if (countEl) countEl.textContent = `${visible} kayıt`;
    };

    searchInput?.addEventListener('input', () => {
      applyFilter();
    });

    applyFilter();
  </script>
</BaseLayout>
