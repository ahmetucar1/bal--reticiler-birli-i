---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Yönetim" description="Duyuru yönetim paneli" canonical="https://www.balmerkezbirligi.org/yonetim">
  <section class="page-shell section-gap">
    <div class="mx-auto max-w-3xl space-y-6">
      <div class="rounded-3xl border border-sand-200 bg-white p-6 shadow-card" id="auth-card">
        <h1 class="text-2xl font-semibold text-slate-900">Yönetim Girişi</h1>
        <p class="mt-2 text-sm text-slate-600">
          Bu sayfa yalnızca yetkili hesap içindir. Google hesabınızla giriş yapın.
        </p>
        <button
          id="google-login"
          class="mt-4 inline-flex items-center justify-center gap-2 rounded-full bg-pine-600 px-5 py-2.5 text-sm font-semibold text-white shadow-card transition hover:-translate-y-0.5 hover:bg-pine-700"
        >
          Google ile giriş yap
        </button>
        <p id="auth-error" class="mt-3 text-sm text-rose-600 hidden"></p>
      </div>

      <div class="rounded-3xl border border-sand-200 bg-white p-6 shadow-card hidden" id="admin-panel">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h2 class="text-xl font-semibold text-slate-900">Duyuru Yayınla</h2>
            <p class="text-sm text-slate-600">Başlık, metin ve görselleri girin.</p>
          </div>
          <button id="logout" class="text-sm font-semibold text-slate-500 hover:text-slate-800">Çıkış</button>
        </div>

        <form id="announcement-form" class="mt-6 space-y-5">
          <div>
            <label class="text-sm font-semibold text-slate-700" for="title">Duyuru başlığı</label>
            <input
              id="title"
              name="title"
              required
              class="mt-2 w-full rounded-xl border border-sand-200 bg-sand-50 px-4 py-3 text-sm outline-none transition focus:border-pine-300 focus:bg-white"
              placeholder="Duyuru başlığı"
            />
          </div>

          <div>
            <label class="text-sm font-semibold text-slate-700" for="body">Duyuru metni</label>
            <textarea
              id="body"
              name="body"
              rows="6"
              required
              class="mt-2 w-full rounded-xl border border-sand-200 bg-sand-50 px-4 py-3 text-sm outline-none transition focus:border-pine-300 focus:bg-white"
              placeholder="Duyuru metni"
            ></textarea>
          </div>

          <div>
            <label class="text-sm font-semibold text-slate-700" for="event-date">Duyuru tarihi</label>
            <input
              id="event-date"
              name="event-date"
              type="date"
              class="mt-2 w-full rounded-xl border border-sand-200 bg-sand-50 px-4 py-3 text-sm outline-none transition focus:border-pine-300 focus:bg-white"
            />
          </div>

          <div>
            <label class="text-sm font-semibold text-slate-700" for="images">Duyuru fotoğrafları</label>
            <input
              id="images"
              name="images"
              type="file"
              accept="image/*"
              multiple
              class="mt-2 block w-full text-sm text-slate-600"
            />
            <p class="mt-2 text-xs text-slate-500">Yüklemeden önce kapak fotoğrafını seçebilirsiniz.</p>
          </div>

          <div id="preview" class="grid gap-3 sm:grid-cols-2"></div>

          <div class="flex flex-wrap gap-3">
            <button
              type="button"
              id="upload"
              class="inline-flex items-center justify-center rounded-full border border-pine-600 px-5 py-2 text-sm font-semibold text-pine-700 transition hover:bg-pine-50"
            >
              Fotoğrafları yükle
            </button>
            <button
              type="submit"
              id="publish"
              class="inline-flex items-center justify-center rounded-full bg-pine-600 px-5 py-2 text-sm font-semibold text-white shadow-card transition hover:-translate-y-0.5 hover:bg-pine-700"
              disabled
            >
              Yayınla
            </button>
            <button
              type="button"
              id="reset"
              class="inline-flex items-center justify-center rounded-full border border-sand-200 px-5 py-2 text-sm font-semibold text-slate-600 hover:bg-sand-50"
            >
              Temizle
            </button>
          </div>

          <p id="status" class="text-sm text-slate-600"></p>
        </form>

        <div class="mt-8 space-y-3">
          <h3 class="text-lg font-semibold text-slate-900">Mevcut duyurular</h3>
          <div id="announcement-list" class="space-y-3"></div>
        </div>
      </div>
    </div>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, serverTimestamp, doc, getDocs, deleteDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAl_TPmEOlbliY3CDig7p-VGbSEVoFxl2c",
      authDomain: "merkez-birligi.firebaseapp.com",
      projectId: "merkez-birligi",
      storageBucket: "merkez-birligi.firebasestorage.app",
      messagingSenderId: "1017642940775",
      appId: "1:1017642940775:web:7c7ace1b2cba16a6fdd7c2",
      measurementId: "G-LT1MWENXB7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const allowedEmail = "ucaraahmet@gmail.com";

    const authCard = document.getElementById("auth-card");
    const adminPanel = document.getElementById("admin-panel");
    const loginBtn = document.getElementById("google-login");
    const logoutBtn = document.getElementById("logout");
    const resetBtn = document.getElementById("reset");
    const authError = document.getElementById("auth-error");
    const listEl = document.getElementById("announcement-list");
    const form = document.getElementById("announcement-form");
    const titleInput = document.getElementById("title");
    const bodyInput = document.getElementById("body");
    const eventDateInput = document.getElementById("event-date");
    const imagesInput = document.getElementById("images");
    const preview = document.getElementById("preview");
    const uploadBtn = document.getElementById("upload");
    const publishBtn = document.getElementById("publish");
    const statusEl = document.getElementById("status");

    let selectedIndex = 0;
    let uploadedImages = [];
    let currentDocId = "";
    let currentData = null;
    let editMode = false;
    let announcements = [];

    const showError = (message) => {
      authError.textContent = message;
      authError.classList.remove("hidden");
    };

    const formatDateLabel = (value) => {
      if (!value) return "Tarih girilmedi";
      if (typeof value === "string") {
        const parsed = new Date(value);
        if (Number.isNaN(parsed.getTime())) return value;
        return new Intl.DateTimeFormat("tr-TR", { day: "2-digit", month: "long", year: "numeric" }).format(parsed);
      }
      const date = value instanceof Date ? value : value.toDate?.() || new Date(value);
      if (Number.isNaN(date.getTime())) return "Tarih girilmedi";
      return new Intl.DateTimeFormat("tr-TR", { day: "2-digit", month: "long", year: "numeric" }).format(date);
    };

    const toInputDate = (value) => {
      if (!value) return "";
      if (typeof value !== "string") return "";
      const parsed = new Date(value);
      if (Number.isNaN(parsed.getTime())) return value;
      return parsed.toISOString().slice(0, 10);
    };

    const resetForm = () => {
      form.reset();
      preview.innerHTML = "";
      statusEl.textContent = "";
      selectedIndex = 0;
      uploadedImages = [];
      currentDocId = "";
      currentData = null;
      editMode = false;
      publishBtn.textContent = "Yayınla";
      publishBtn.disabled = true;
      uploadBtn.disabled = false;
    };

    const buildPreviewFromFiles = (files) => {
      preview.innerHTML = "";
      if (!files.length) return;
      files.forEach((file, index) => {
        const wrapper = document.createElement("label");
        wrapper.className = "flex items-center gap-3 rounded-xl border border-sand-200 bg-sand-50 px-3 py-2 text-sm";
        wrapper.innerHTML = `
          <input type="radio" name="cover" ${index === 0 ? "checked" : ""} />
          <span class="inline-flex h-10 w-14 items-center justify-center rounded-lg bg-white shadow-sm overflow-hidden">
            <img src="${URL.createObjectURL(file)}" alt="${file.name}" class="h-full w-full object-cover" />
          </span>
          <span class="truncate">${file.name}</span>
        `;
        const radio = wrapper.querySelector("input");
        radio.addEventListener("change", () => {
          selectedIndex = index;
        });
        preview.appendChild(wrapper);
      });
    };

    const buildPreviewFromImages = (images, coverUrl) => {
      preview.innerHTML = "";
      if (!images.length) return;
      const coverIndex = Math.max(0, images.findIndex((img) => img.url === coverUrl));
      selectedIndex = coverIndex;
      images.forEach((img, index) => {
        const wrapper = document.createElement("label");
        wrapper.className = "flex items-center gap-3 rounded-xl border border-sand-200 bg-sand-50 px-3 py-2 text-sm";
        wrapper.innerHTML = `
          <input type="radio" name="cover" ${index === coverIndex ? "checked" : ""} />
          <span class="inline-flex h-10 w-14 items-center justify-center rounded-lg bg-white shadow-sm overflow-hidden">
            <img src="${img.url}" alt="${img.name || "duyuru"}" class="h-full w-full object-cover" />
          </span>
          <span class="truncate">${img.name || "gorsel"}</span>
        `;
        const radio = wrapper.querySelector("input");
        radio.addEventListener("change", () => {
          selectedIndex = index;
        });
        preview.appendChild(wrapper);
      });
    };

    const getSortedAnnouncements = () => {
      return [...announcements].sort((a, b) => {
        const orderA = typeof a.order === "number" ? a.order : 9999;
        const orderB = typeof b.order === "number" ? b.order : 9999;
        if (orderA !== orderB) return orderA - orderB;
        const timeA = a.createdAt?.seconds || 0;
        const timeB = b.createdAt?.seconds || 0;
        return timeB - timeA;
      });
    };

    const renderList = () => {
      if (!listEl) return;
      const items = getSortedAnnouncements();
      if (!items.length) {
        listEl.innerHTML = "<p class=\"text-sm text-slate-600\">Henüz duyuru yok.</p>";
        return;
      }
      listEl.innerHTML = items
        .map((item, index) => {
          const dateLabel = formatDateLabel(item.eventDate || item.publishedAt);
          return `
            <div class="flex flex-wrap items-center gap-3 rounded-2xl border border-sand-200 bg-sand-50 p-3">
              <img src="${item.coverUrl}" alt="${item.title}" class="h-14 w-20 rounded-lg object-cover" />
              <div class="flex-1 min-w-[180px]">
                <p class="text-[11px] uppercase tracking-[0.18em] text-slate-500">${dateLabel}</p>
                <p class="text-sm font-semibold text-slate-900">${item.title}</p>
              </div>
              <div class="flex items-center gap-2">
                <button data-action="up" data-id="${item.id}" class="rounded-full border border-sand-200 px-2 py-1 text-xs">↑</button>
                <button data-action="down" data-id="${item.id}" class="rounded-full border border-sand-200 px-2 py-1 text-xs">↓</button>
                <button data-action="edit" data-id="${item.id}" class="rounded-full border border-sand-200 px-2 py-1 text-xs">Düzenle</button>
                <button data-action="delete" data-id="${item.id}" class="rounded-full border border-rose-200 px-2 py-1 text-xs text-rose-600">Sil</button>
              </div>
            </div>
          `;
        })
        .join("");
    };

    const loadAnnouncements = async () => {
      const snapshot = await getDocs(collection(db, "announcements"));
      announcements = snapshot.docs.map((docSnap) => ({ id: docSnap.id, ...docSnap.data() }));
      renderList();
    };

    const enterEditMode = (item) => {
      editMode = true;
      currentDocId = item.id;
      currentData = item;
      titleInput.value = item.title || "";
      bodyInput.value = item.body || "";
      eventDateInput.value = toInputDate(item.eventDate);
      uploadedImages = Array.isArray(item.images) ? item.images : [];
      buildPreviewFromImages(uploadedImages, item.coverUrl);
      publishBtn.textContent = "Güncelle";
      publishBtn.disabled = false;
      statusEl.textContent = "Düzenleme modundasınız.";
    };

    const getMinOrder = () => {
      const sorted = getSortedAnnouncements();
      if (!sorted.length) return 0;
      const min = sorted.reduce((acc, item) => {
        const val = typeof item.order === "number" ? item.order : acc;
        return Math.min(acc, val);
      }, sorted[0].order ?? 0);
      return Number.isFinite(min) ? min : 0;
    };

    const swapOrder = async (currentId, direction) => {
      const items = getSortedAnnouncements();
      const index = items.findIndex((item) => item.id === currentId);
      if (index < 0) return;
      const targetIndex = direction === "up" ? index - 1 : index + 1;
      if (targetIndex < 0 || targetIndex >= items.length) return;
      const current = items[index];
      const target = items[targetIndex];
      const currentOrder = typeof current.order === "number" ? current.order : index;
      const targetOrder = typeof target.order === "number" ? target.order : targetIndex;
      await updateDoc(doc(db, "announcements", current.id), { order: targetOrder });
      await updateDoc(doc(db, "announcements", target.id), { order: currentOrder });
      await loadAnnouncements();
    };

    const seedAnnouncements = [
      {
        id: "sanliurfa-genel-kurul",
        title: "Şanlıurfa Bal Üreticiler Birliğinde gerçekleştirilen genel kurulda Fırat Çenberlitaş güven tazeleyerek görevine devam etti.",
        body: "Şanlıurfa Bal Üreticiler Birliğinde gerçekleştirilen genel kurulda Fırat Çenberlitaş güven tazeleyerek görevine devam etti.",
        coverUrl: "/assets/duyurular/0.jpeg",
        images: [
          { url: "/assets/duyurular/0.jpeg", name: "0.jpeg" },
          { url: "/assets/duyurular/0.1.jpeg", name: "0.1.jpeg" },
          { url: "/assets/duyurular/0.2.jpeg", name: "0.2.jpeg" },
          { url: "/assets/duyurular/0.3.jpeg", name: "0.3.jpeg" },
          { url: "/assets/duyurular/0.4.jpeg", name: "0.4.jpeg" },
          { url: "/assets/duyurular/0.5.jpeg", name: "0.5.jpeg" },
          { url: "/assets/duyurular/0.6.jpeg", name: "0.6.jpeg" },
          { url: "/assets/duyurular/0.7.jpeg", name: "0.7.jpeg" },
          { url: "/assets/duyurular/0.8.jpeg", name: "0.8.jpeg" },
          { url: "/assets/duyurular/0.9.jpeg", name: "0.9.jpeg" },
          { url: "/assets/duyurular/0.10.jpeg", name: "0.10.jpeg" },
          { url: "/assets/duyurular/0.11.jpeg", name: "0.11.jpeg" },
          { url: "/assets/duyurular/0.12.jpeg", name: "0.12.jpeg" },
          { url: "/assets/duyurular/0.13.jpeg", name: "0.13.jpeg" },
          { url: "/assets/duyurular/0.14.jpeg", name: "0.14.jpeg" }
        ],
        order: 0
      },
      {
        id: "bitlis-valisi-ziyareti",
        title: "Bitlis ve Hizan birlik başkanlarımızla birlikte gerçekleştirdiğimiz Bitlis Valimiz Sayın Ahmet Karakaya ziyareti.",
        body: "Türkiye Bal Üreticileri Merkez Birliği olarak, Bitlis ve Hizan birlik başkanlarımızla birlikte bugün Bitlis Valimiz Sayın Ahmet Karakaya'yı ziyaret ederek Bitlis ilimizde yürüteceğimiz projeler ve arıcılık faaliyetlerinin geliştirilmesine yönelik konular hakkında istişarelerde bulunduk, ilimiz arıcılığına gösterdikleri ilgi ve yapıcı yaklaşımı için kendilerine teşekkür ederiz. Ayrıca başkanlarımızla birlikte İl Tarım Müdürlüğümüzü ziyaret ederek, kurumsal yapıların güçlendirilmesi ve arıcılık faaliyetlerinin geliştirilmesine yönelik değerlendirmelerde bulunduk.",
        coverUrl: "/assets/duyurular/1.jpeg",
        images: [
          { url: "/assets/duyurular/1.jpeg", name: "1.jpeg" },
          { url: "/assets/duyurular/1.1.jpeg", name: "1.1.jpeg" },
          { url: "/assets/duyurular/1.2.jpeg", name: "1.2.jpeg" },
          { url: "/assets/duyurular/1.3.jpeg", name: "1.3.jpeg" },
          { url: "/assets/duyurular/1.4.jpeg", name: "1.4.jpeg" },
          { url: "/assets/duyurular/1.5.jpeg", name: "1.5.jpeg" }
        ],
        eventDate: "2026-02-18",
        order: 1
      },
      {
        id: "diyarbakir-birligi-taziye-ziyareti",
        title: "Diyarbakır Bal Üreticileri Birliğimizi ziyaret ederek, önceki dönem başkanlarımızdan merhum Ali Rıza Demir’in oğullarına taziyelerimizi ilettik.",
        body: "Diyarbakır Bal Üreticileri Birliğimizi ziyaret ederek, önceki dönem başkanlarımızdan merhum Ali Rıza Demir’in oğullarına taziyelerimizi ilettik.",
        coverUrl: "/assets/duyurular/2.jpg",
        images: [{ url: "/assets/duyurular/2.jpg", name: "2.jpg" }],
        order: 2
      },
      {
        id: "sanliurfa-bassagligi-ziyareti",
        title: "Yönetim kurulu olarak; Şanlıurfa Arıcılar Birliği Başkanımızın kıymetli annesinin vefatı dolayısıyla kendisini ziyaret ederek başsağlığı dileklerimizi ilettik.",
        body: "Yönetim kurulu olarak; Şanlıurfa Arıcılar Birliği Başkanımızın kıymetli annesinin vefatı dolayısıyla kendisini ziyaret ederek başsağlığı dileklerimizi ilettik.",
        coverUrl: "/assets/duyurular/3.jpg",
        images: [{ url: "/assets/duyurular/3.jpg", name: "3.jpg" }],
        order: 3
      },
      {
        id: "ankara-teskilatlanma-gorusmesi",
        title: "Ankara’da Teşkilatlanma Daire Başkanı Sayın Ahmet Ünsal ile il bazlı yapılanma konusunda son derece olumlu görüşmeler gerçekleştirilmiştir.",
        body: "Ankara’da Teşkilatlanma Daire Başkanı Sayın Ahmet Ünsal ile il bazlı yapılanma konusunda son derece olumlu görüşmeler gerçekleştirilmiştir.\n\nBulundukları illerde ilçe bazlı kurulmuş birliklerimizden, mali genel kurullarını yapmadan önce il birliği statüsüne geçmeyi düşünenler varsa, çok ivedi bir şekilde Merkez Birliğimiz ile iletişime geçmeleri gerekmektedir.\n\nİl bazlı yapılanma sürecinde birkaç işlemin tamamlanmasının ardından il bazlı statüye geçiş mümkün olacaktır.\n\nBirliklerimizin daha güçlü ve kurumsal bir yapıya kavuşabilmesi adına, ilçe bazlı değil il bazlı teşkilatlanma büyük önem arz etmektedir.",
        coverUrl: "/assets/duyurular/4.jpg",
        images: [{ url: "/assets/duyurular/4.jpg", name: "4.jpg" }],
        order: 4
      },
      {
        id: "turk-patent-ziyareti",
        title: "Türk Patent ve Marka Kurumu Başkanı Prof. Dr. Muhammed Zeki Durak’ı, Merkez Birliğimiz olarak makamında ziyaret ettik.",
        body: "Türk Patent ve Marka Kurumu Başkanı Prof. Dr. Muhammed Zeki Durak’ı, Merkez Birliğimiz olarak makamında ziyaret ettik. Bal ve arı ürünlerimizin markalaşması ile coğrafi işaretler konularında verimli bir görüşme gerçekleştirdik.",
        coverUrl: "/assets/duyurular/5.jpg",
        images: [{ url: "/assets/duyurular/5.jpg", name: "5.jpg" }],
        order: 5
      },
      {
        id: "gaziantep-sertifika-toreni",
        title: "Bal üreticileri birliklerimiz her geçen gün daha kurumsal bir yapıya kavuşuyor ve büyümeye devam ediyor.",
        body: "Bal üreticileri birliklerimiz her geçen gün daha kurumsal bir yapıya kavuşuyor ve büyümeye devam ediyor.\n\nGaziantep Bal Üreticileri Birliği Başkanımız Mehmet Uçar’ın öncülüğünde, bakanlık tarafından belgelendirilen eğitim programı kapsamında; Merkez Birliğimiz Yönetim Kurulu Başkan Yardımcımız Mehmet Ali Kutlu hocamızın eğitmen olarak yer aldığı proje doğrultusunda belgelendirme töreni gerçekleştirilmiş ve başarılı arıcılarımıza bakanlık onaylı ana arı sertifikaları takdim edilmiştir.\n\nEmeği geçen başta Gaziantep Birliğimiz olmak üzere, kıymetli hocamıza ve tüm paydaşlara teşekkür eder, sertifika alan arıcılarımızı tebrik ederiz.",
        coverUrl: "/assets/duyurular/7.jpeg",
        images: [
          { url: "/assets/duyurular/7.jpeg", name: "7.jpeg" },
          { url: "/assets/duyurular/7.1.jpeg", name: "7.1.jpeg" },
          { url: "/assets/duyurular/7.2.jpeg", name: "7.2.jpeg" },
          { url: "/assets/duyurular/7.3.jpeg", name: "7.3.jpeg" },
          { url: "/assets/duyurular/7.4.jpeg", name: "7.4.jpeg" },
          { url: "/assets/duyurular/7.5.jpeg", name: "7.5.jpeg" },
          { url: "/assets/duyurular/7.6.jpeg", name: "7.6.jpeg" }
        ],
        order: 6
      },
      {
        id: "ari-yetistiricileri-birligi-hayirli-olsun",
        title: "Türkiye Arı Yetiştiricileri Merkez Birliği Genel Başkanı Ali Demir ve kıymetli yönetim kurulu bugün Merkez Birliğimize hayırlı olsun ziyaretinde bulunmuştur.",
        body: "Türkiye Arı Yetiştiricileri Merkez Birliği Genel Başkanı Ali Demir ve kıymetli yönetim kurulu bugün Merkez Birliğimize hayırlı olsun ziyaretinde bulunmuştur.",
        coverUrl: "/assets/duyurular/8.jpeg",
        images: [
          { url: "/assets/duyurular/8.jpeg", name: "8.jpeg" },
          { url: "/assets/duyurular/8.1.jpeg", name: "8.1.jpeg" },
          { url: "/assets/duyurular/8.2.jpeg", name: "8.2.jpeg" }
        ],
        order: 7
      }
    ];

    loginBtn?.addEventListener("click", async () => {
      authError.classList.add("hidden");
      try {
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      } catch (error) {
        showError("Giriş başarısız. Tekrar deneyin.");
      }
    });

    logoutBtn?.addEventListener("click", async () => {
      await signOut(auth);
    });

    resetBtn?.addEventListener("click", () => {
      resetForm();
    });

    const ensureSeeded = async () => {
      const probe = await getDoc(doc(db, "announcements", "sanliurfa-genel-kurul"));
      if (probe.exists()) return;

      await Promise.all(
        seedAnnouncements.map((item) => {
          return setDoc(
            doc(db, "announcements", item.id),
            {
              title: item.title,
              body: item.body,
              coverUrl: item.coverUrl,
              images: item.images,
              order: item.order,
              eventDate: item.eventDate || "",
              publishedAt: serverTimestamp(),
              createdAt: serverTimestamp()
            },
            { merge: true }
          );
        })
      );
    };

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        authCard?.classList.remove("hidden");
        adminPanel?.classList.add("hidden");
        return;
      }
      if (user.email !== allowedEmail) {
        showError("Bu hesap yetkili değil. Lütfen doğru hesapla giriş yapın.");
        signOut(auth);
        return;
      }
      authCard?.classList.add("hidden");
      adminPanel?.classList.remove("hidden");
      await ensureSeeded();
      await loadAnnouncements();
    });

    imagesInput?.addEventListener("change", (event) => {
      const files = Array.from(event.target.files || []);
      selectedIndex = 0;
      uploadedImages = [];
      publishBtn.disabled = true;
      statusEl.textContent = "";
      buildPreviewFromFiles(files);
      if (!editMode) {
        currentDocId = "";
      }
    });

    uploadBtn?.addEventListener("click", async () => {
      const files = Array.from(imagesInput.files || []);
      if (!files.length) {
        statusEl.textContent = "Lütfen fotoğraf seçin.";
        return;
      }
      if (!titleInput.value.trim() || !bodyInput.value.trim()) {
        statusEl.textContent = "Başlık ve metin girin.";
        return;
      }

      statusEl.textContent = "Fotoğraflar yükleniyor...";
      uploadBtn.disabled = true;

      try {
        let docId = currentDocId;
        if (!docId) {
          const docRef = await addDoc(collection(db, "announcements"), {
            title: titleInput.value.trim(),
            body: bodyInput.value.trim(),
            eventDate: eventDateInput.value || "",
            createdAt: serverTimestamp(),
            publishedAt: null,
            order: null
          });
          docId = docRef.id;
          currentDocId = docId;
        }

        const uploads = await Promise.all(
          files.map(async (file) => {
            const storageRef = ref(storage, `announcements/${docId}/${file.name}`);
            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);
            return { url, path: storageRef.fullPath, name: file.name };
          })
        );

        uploadedImages = uploads;
        await updateDoc(doc(db, "announcements", docId), {
          images: uploads,
          coverUrl: uploads[selectedIndex]?.url || uploads[0].url,
          coverPath: uploads[selectedIndex]?.path || uploads[0].path
        });

        statusEl.textContent = editMode ? "Görseller güncellendi." : "Yükleme tamamlandı. Yayınla butonuna basabilirsiniz.";
        publishBtn.disabled = false;
      } catch (error) {
        const message = error?.message || error?.code || "Yükleme sırasında hata oluştu.";
        statusEl.textContent = `Yükleme sırasında hata oluştu: ${message}`;
      } finally {
        uploadBtn.disabled = false;
      }
    });

    form?.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!currentDocId) {
        statusEl.textContent = "Önce fotoğrafları yükleyin.";
        return;
      }

      const docs = uploadedImages.length ? uploadedImages : (currentData?.images || []);
      if (!docs.length) {
        statusEl.textContent = "Fotoğraf bulunamadı.";
        return;
      }

      statusEl.textContent = editMode ? "Güncelleniyor..." : "Yayınlanıyor...";
      publishBtn.disabled = true;

      try {
        const cover = docs[selectedIndex] || docs[0] || (currentData?.coverUrl ? { url: currentData.coverUrl, path: currentData.coverPath } : null);
        if (!cover?.url) {
          statusEl.textContent = "Kapak fotoğrafı bulunamadı.";
          publishBtn.disabled = false;
          return;
        }

        const updates = {
          title: titleInput.value.trim(),
          body: bodyInput.value.trim(),
          eventDate: eventDateInput.value || currentData?.eventDate || "",
          images: docs,
          coverUrl: cover.url
        };
        if (cover.path) {
          updates.coverPath = cover.path;
        }

        if (!editMode) {
          const newOrder = getMinOrder() - 1;
          updates.publishedAt = serverTimestamp();
          updates.order = newOrder;
        } else if (!currentData?.publishedAt) {
          updates.publishedAt = serverTimestamp();
        }

        await updateDoc(doc(db, "announcements", currentDocId), updates);

        statusEl.textContent = editMode ? "Duyuru güncellendi." : "Duyuru yayınlandı.";
        resetForm();
        await loadAnnouncements();
      } catch (error) {
        const message = error?.message || error?.code || "Yayınlama sırasında hata oluştu.";
        statusEl.textContent = `Yayınlama sırasında hata oluştu: ${message}`;
      }
    });

    listEl?.addEventListener("click", async (event) => {
      const button = event.target.closest("button");
      if (!button) return;
      const id = button.dataset.id;
      const action = button.dataset.action;
      if (!id || !action) return;

      const item = announcements.find((entry) => entry.id === id);
      if (!item) return;

      if (action === "edit") {
        enterEditMode(item);
        return;
      }

      if (action === "delete") {
        if (!confirm("Duyuru silinsin mi?")) return;
        try {
          if (Array.isArray(item.images)) {
            await Promise.all(
              item.images.map(async (img) => {
                if (!img.path || img.path.startsWith("/")) return;
                await deleteObject(ref(storage, img.path));
              })
            );
          }
          await deleteDoc(doc(db, "announcements", id));
          await loadAnnouncements();
        } catch (error) {
          statusEl.textContent = "Silme işlemi başarısız.";
        }
        return;
      }

      if (action === "up" || action === "down") {
        await swapOrder(id, action);
      }
    });
  </script>
</BaseLayout>
